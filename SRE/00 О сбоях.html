<!DOCTYPE html>
<html>

<head>
    <!-- <link rel="stylesheet" href="../resources/reveal.js/reset.css" /> -->
    <link rel="stylesheet" href="../resources/reveal.js/reveal.css" />
    <!-- <link rel="stylesheet" href="../resources/reveal.js/theme/white.css" /> -->
    <link rel="stylesheet" href="../resources/fontawesome-free-6.2.0-web/css/all.min.css" />
    <!-- <link rel="stylesheet" href="../custom/css/theme.css" /> -->
    <script src="../resources/reveal.js/reveal.js"></script>
    <script src="../resources/reveal.js/notes.js"></script>
    <script src="../custom/init.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        @layer base {
            h1 {
              @apply text-4xl bg-amber-600 inline-block mt-8 mb-6 p-2 text-white;
            }
            h2 {
              @apply text-3xl text-amber-600 my-2;
            }
            section {
                @apply text-2xl;
            }
            .dev {
                @apply border border-black border-dashed;
            }
            p {
                @apply my-4;
            }
            img {
                @apply mx-auto;
            }
            .p2 {
                @apply flex;
            }
            .p2 > div {
                @apply flex-1;
            }
            pre {
                @apply mx-auto w-fit overflow-scroll text-xl;
                max-width: 930px;
                max-height: 550px;
            }
            pre, code {
                @apply text-left;
            }
            ul, ol {
                @apply text-left mx-auto marker:text-amber-600 w-fit;
                max-width: 800px;
            }
            ol {
                @apply list-decimal;
            }
            ul {
                @apply list-disc;
            }
            ol ul, ul ul, ol ol, ul ol {
                @apply ml-12;
            }
            li {
                @apply pl-4;
            }
          }
    </style>
</head>

<body>
    <div class="reveal">
        <div class="slides">
            <section>
                <section>
                    <h1 class="text-4xl bg-amber-600 inline-block p-2 text-white">Надежность информационных систем</h1>
                    <p>Лекции</p>
                </section>
                <section>
                    <h1 class="text-4xl bg-amber-600 inline-block p-2 text-white">Зачем это изучать?</h1>
                    <p>
                    <ul>
                        <li class="fragment">Если <em>не</em> работать в ИТ?</li>
                        <li class="fragment">Если работать в ИТ?</li>
                    </ul>
                    </p>
                </section>
                <section>
                    <img src="imgs/wonder-world.jpeg" />
                </section>
            </section>
            <section>
                <section>
                    <h1>Организационная информация</h1>
                </section>
                <section>
                    <h1>Лектор</h1>
                    <p>Масленников Дмитрий Михайлович</p>
                    <p><em>Руководитель центра надежности ИС</em></p>
                </section>
                <section>
                    <h1>Лекции</h1>
                    <p>
                    <ul>
                        <li class="fragment">Обязательно посещаем</li>
                        <li class="fragment">В конце курса сдаем экзамен по билетам</li>
                        <li class="fragment">Итоговая оценка не должна быть ниже 3 (из 10)</li>
                    </ul>
                    </p>
                </section>
                <section>
                    <h1>Семинары</h1>
                    <p>
                    <ul>
                        <li class="fragment">Обязательно посещаем</li>
                        <li class="fragment">Делаем практические работы</li>
                        <li class="fragment">Итоговая оценка не должна быть ниже 3 (из 10)</li>
                    </ul>
                    </p>
                </section>
                <section>
                    <h1>Итоговая оценка</h1>
                    <p>
                        <code>0.4 оценка_за_экзамен + 0.6 оценка_за_семинары</code><br>
                        <code>оценка_за_экзамен >= 3 (из 10)</code><br>
                        <code>оценка_за_семинары >= 3 (из 10)</code>
                    </p>
                </section>
            </section>
            <section>
                <section>
                    <h1>Сбои</h1>
                    <p>Сбои бывают не только в ИТ</p>
                </section>
                <section>
                    <h1>Катастрофа шаттла «Челленджер»</h1>
                    <div class="r-stack">
                        <img class="fragment fade-out" data-fragment-index="0" width="500"
                            src="https://upload.wikimedia.org/wikipedia/commons/d/dd/STS-7_Landing_%2818331938034%29.jpg" />
                        <img class="fragment fade-in" data-fragment-index="0" width="500"
                            src="https://upload.wikimedia.org/wikipedia/commons/9/9f/Challenger_explosion.jpg" />
                    </div>
                </section>
                <section>
                    <h1>Авария на Deepwater Horizon</h1>
                    <div class="r-stack">
                        <img class="fragment fade-out" data-fragment-index="0" width="500"
                            src="https://upload.wikimedia.org/wikipedia/en/e/e0/Deepwater_Horizon.jpg" />
                        <img class="fragment fade-in" data-fragment-index="0" width="500"
                            src="https://upload.wikimedia.org/wikipedia/commons/9/9d/Deepwater_Horizon_offshore_drilling_unit_on_fire_2010.jpg" />
                    </div>
                </section>
                <section>
                    <div class="p2">
                        <div>
                            <p>Фильм по мотивам:</p>
                            <p>
                                <a href="https://www.kinopoisk.ru/film/607737/">«Глубоководный горизонт»</a><br />
                                Deepwater Horizon
                            </p>
                            <p>2016</p>
                            <img width="250" src="imgs/deepwater_horizon_qrcode.png" />
                        </div>
                        <div>
                            <img width="350"
                                src="https://avatars.mds.yandex.net/get-kinopoisk-image/1777765/7d48bcd9-e52a-4b39-8549-19f9ec2947a0/1920x" />
                        </div>
                    </div>
                </section>
                <section>
                    <h1>Авария на Чернобыльской АЭС</h1>
                    <img width="400" src="https://upload.wikimedia.org/wikipedia/ru/1/1b/Chernobyl_Disaster.jpg" />
                </section>
                <section>
                    <h1>Аполлон 13</h1>
                    <img width="350"
                        src="https://upload.wikimedia.org/wikipedia/commons/4/43/Apollo_13_Service_Module_-_AS13-59-8500_%28cropped%29.jpg" />
                </section>
            </section>
            <section>
                <h1>Сбои в ИТ системах</h1>
            </section>
            <section>
                <section>
                    <h1>Работа с настройками</h1>
                    <p>Масштабный сбой в мобильном банке на Android</p>
                    <p><em>11 декабря 2020</em></p>
                </section>
                <section>
                    <div class="p2">
                        <div>
                            <p>На Android не отображались счета и
                                продукты на главном экране</p>
                            <p>Пострадало около 300 тысяч пользователей</p>
                            <p>Написали РБК, ТАСС и Коммерсант</p>
                        </div>
                        <div>
                            <img style="border: dotted white 1px;" width="300"
                                src="imgs/postmortems/screenshot-01.jpeg" />
                        </div>
                    </div>
                </section>
                <section>
                    <h1>Причины</h1>
                    <ul>
                        <li class="fragment">Сначала думали, что дело в «историях» — потеряли время</li>
                        <li class="fragment">Оказалось, что добавили новый продукт, но заполнили не все поля</li>
                        <li class="fragment">Продукты добавлялись простым редактированием JSON</li>
                        <li class="fragment">Не было валидации на сервере</li>
                        <li class="fragment">Не было валидации на клиенте (мобильное приложение)</li>
                        <li class="fragment">Мобильное приложение Android не отображало все продукты, а не только
                            один
                            невалидный</li>
                        <li class="fragment">Мобильные приложения кешировали список продуктов на сутки</li>
                        <li class="fragment">Возможность принудительного сброса кеша не была предусмотрена</li>
                        <li class="fragment">Возможность массовой коммуникации с пользователями не была
                            предусмотрена
                        </li>
                    </ul>
                </section>
                <section>
                    <h1>Выводы</h1>
                    <ul>
                        <li class="fragment">Надо валидировать настройки приложения, даже если их меняет опытный
                            администратор</li>
                        <li class="fragment">Мобильное приложение должно валидировать данные пришедшие с сервера
                        </li>
                        <li class="fragment">Мобильное приложение должно уметь работать с частично валидными данными
                        </li>
                        <li class="fragment">Кешами на мобильном приложении надо уметь управлять с сервера</li>
                        <li class="fragment">В мобильное приложение надо предусмотреть возможность коммуникации с
                            пользователями во время сбоев</li>
                    </ul>
                </section>
            </section>
            <section>
                <section>
                    <h1>Про алгоритмы и асимптотику</h1>
                    <p>Система аналитики Sage</p>
                    <p><em>23-24 сентября 2020</em></p>
                </section>
                <section>
                    <h1>Пример Sage запроса</h1>
                    <pre>
                <code>
group="platform_client"
    (level:"ERROR" OR level:"FATAL" OR level:"WARN")
    "TypeError" env="prod"
| where
    if("(pfp|pwa).*" != ".*", 
        appName=="(pfp|pwa).*",
        appName:"pwa*" OR appName:"pfp*")
| timechart count as TypeError
                </code>
                </pre>
                </section>
                <section>
                    <h2>Соответствующий запрос в Elastic Search</h2>
                    <pre>
                    <code>
{
   "query":{
      "bool":{
         "must":[
            {
               "range":{
                  "@timestamp":{
                     "gte":"2020-09-25T03:28:19.269Z",
                     "lt":"2020-09-25T09:28:19.269Z"
                  }
               }
            },
            {
               "bool":{
                  "filter":[
                     {
                        "bool":{
                           "filter":[
                              {
                                 "bool":{
                                    "filter":[
                                       {
                                          "term":{
                                             "group":"platform_client"
                                          }
                                       },
                                       {
                                          "bool":{
                                             "should":[
                                                {
                                                   "span_near":{
                                                      "in_order":true,
                                                      "slop":0,
                                                      "clauses":[
                                                         {
                                                            "span_term":{
                                                               "level":"error"
                                                            }
                                                         }
                                                      ]
                                                   }
                                                },
                                                {
                                                   "bool":{
                                                      "should":[
                                                         {
                                                            "span_near":{
                                                               "in_order":true,
                                                               "slop":0,
                                                               "clauses":[
                                                                  {
                                                                     "span_term":{
                                                                        "level":"fatal"
                                                                     }
                                                                  }
                                                               ]
                                                            }
                                                         },
                                                         {
                                                            "span_near":{
                                                               "in_order":true,
                                                               "slop":0,
                                                               "clauses":[
                                                                  {
                                                                     "span_term":{
                                                                        "level":"warn"
                                                                     }
                                                                  }
                                                               ]
                                                            }
                                                         }
                                                      ]
                                                   }
                                                }
                                             ]
                                          }
                                       }
                                    ]
                                 }
                              },
                              {
                                 "span_near":{
                                    "in_order":true,
                                    "slop":0,
                                    "clauses":[
                                       {
                                          "span_term":{
                                             "all":"typeerror"
                                          }
                                       }
                                    ]
                                 }
                              }
                           ]
                        }
                     },
                     {
                        "script":{
                           "script":{
                              "lang":"painless",
                              "source":"
                                boolean fulltextSearch(String s, String p) {\n
                                    s = s.toString().toLowerCase();\n
                                    p = p.toString().toLowerCase();\n
                                    if (!p.contains('*')) {\n
                                        return s.contains(p);\n
                                    }\n
                                    int i = 0;\n
                                    int j = 0;\n
                                    int starIndex = -1;\n
                                    int iIndex = -1;\n
                                    while (i < s.length()) {\n
                                        if (j < p.length() && p.charAt(j) == s.charAt(i)) {\n
                                            ++i;\n
                                            ++j;\n
                                        } else if (j < p.length() && p.charAt(j) == (char)'*') {\n
                                            starIndex = j;\n
                                            iIndex = i;\n
                                            j++;\n
                                        } else if (starIndex != -1) {\n
                                            j = starIndex + 1;\n
                                            i = iIndex+1;\n
                                            iIndex++;\n
                                        } else {\n
                                            return false;\n
                                        }\n
                                    }\n
                                    while (j < p.length() && p.charAt(j) == (char)'*') {\n
                                        ++j;\n
                                    }\n
                                    return j == p.length();\n
                                }
                                def s11 = \"pfp*\";
                                def s10 = (
                                    !doc.containsKey('appName.keyword')
                                        || doc['appName.keyword'].size() == 0 ? null : doc['appName.keyword'].value);
                                def s12 = ((s10) != null && fulltextSearch(s10,s11));
                                def s8 = \"pwa*\";
                                def s7 = (
                                    !doc.containsKey('appName.keyword') 
                                        || doc['appName.keyword'].size() == 0 ? null : doc['appName.keyword'].value);
                                def s9 = ((s7) != null && fulltextSearch(s7,s8));
                                def s13 = (s9 == null || s12 == null ? null : s9 || s12);
                                def s5 = \"(pfp|pwa).*\";
                                def s4 = (
                                    !doc.containsKey('appName.keyword')
                                        || doc['appName.keyword'].size() == 0 ? null : doc['appName.keyword'].value);
                                def s6 = (s4 == s5);
                                def s2 = \".*\";
                                def s1 = \"(pfp|pwa).*\";
                                def s3 = (s1 != s2);
                                def result = (s3 === true ? s6 : s13);
                                return result == null ? false : result"
                           }
                        }
                     }
                  ]
               }
            }
         ]
      }
   },
   "aggs":{
      "buckets":{
         "composite":{
            "sources":[
               {
                  "@timestamp":{
                     "date_histogram":{
                        "field":"@timestamp",
                        "fixed_interval":"300s"
                     }
                  }
               }
            ],
            "size":2500
         },
         "aggs":{
            
         }
      }
   },
   "_source":true,
   "track_total_hits":true,
   "size":0
}
                    </code>
                    </pre>
                </section>
                <section>
                    <h1>24 июля</h1>
                    <p>
                        Выложен новый функционал: функция <code>case</code>
                    </p>
                    <pre>
                    <code>
group="default" 
| eval priority=case(level="INFO", "1", level="DEBUG", "2")
| fields level, status                    
                    </code>
                </pre>
                </section>
                <section>
                    <h1>23 сентября</h1>
                    <p>Пользователь посылает запрос</p>
                    <pre>
                    <code>
group="mp_smsc" logfile:"1-smsc*"
| eval kodik=case(
        Error_code="1-02", "Некорректный адрес отправителя",
        Error_code="1-03", "Адрес отправителя обнаружен в черном списке",
        Error_code="1-04", "Адрес получателя обнаружен в черном списке",
        <Еще 19 похожих строк...>
        Error_code="8-01", "Попытка регистрации дубликата части конкатенированного сообщения"
    )
| timechart span=10m count by kodik, inst
                    </code>
                </pre>
                </section>
                <section>
                    <h1>Фрагмент запроса в Elastic Search</h1>
                    <pre>
                    <code>
return (
    s3 === true ? s4 :
        s7 === true ? s8 :
        s11 === true ? s12 :
        s15 === true ? s16 :
        s19 === true ? s20 :
        <...>
        s91 === true ? s92 :
        null
);
                    </code>
                </pre>
                </section>
                <section>
                    <h1>Баг в Elastic Search</h1>
                    <img width="800" src="imgs/GitHub_screenshot.png">
                </section>
                <section>
                    <h1>«Осбенности» бага в Elastic</h1>
                    <p>
                    <ul>
                        <li class="fragment">Все работает «без ошибок», только очень медленно</li>
                        <li class="fragment">У Elastic Search все Painless Script запросы парсятся одним воркером
                        </li>
                        <li class="fragment">Запросы с Painles Script блокируют один воркер для процессинга запросов
                            до
                            стадии парсинга</li>
                        <li class="fragment">Запросы без Painless Script работают, пока не закончатся воркеры
                            процессинга</li>
                        <li class="fragment">Сам Elastic думает, что у него все работает</li>
                    </ul>
                    </p>
                </section>
                <section>
                    <h1>Второй баг</h1>
                    <p>Приложение, реализующее преобразование запросов, не освобождало соединения при таймауте со
                        стороны
                        Elastic Search</p>
                    <p>Наличие второго бага существенно осложнило поиск причин сбоев</p>
                </section>
                <section>
                    <p>
                        У Sage тысячи пользователей, которые генерируют много запросов.
                    </p>
                    <p>
                        Даже догадавшись, что дело в «плохом» запросе, поиск его — поиск «иголки в стоге сена».
                    </p>
                </section>
                <section>
                    <h1>Выводы</h1>
                    <p>
                    <ul>
                        <li class="fragment">Проблема может проявиться сильно после релиза</li>
                        <li class="fragment">Если пользователям доступен язык запросов, то тестировать становится
                            сильно сложнее</li>
                        <li class="fragment">Несколько проблем могут закрывать дург друга усложняя поиск причин</li>
                        <li class="fragment">Асимптотика важна в неожиданных местах</li>
                    </ul>
                    </p>
                </section>
            </section>
            <section>
                <section>
                    <h1>Каскадный сбой от маленькой утилиты</h1>
                    <p><em>17 февраля 2021</em></p>
                </section>
                <section>
                    <h1>Filebeat</h1>
                    <p>
                        Простая утилита для загрузки логов
                    </p>
                    <p>
                        Filebeat обычно используется для загрузки логов в Elastic Search
                    </p>
                </section>
                <section>
                    <h1>17 февраля в 15:08</h1>
                    <p>Filebeat загрузил CPU одной из нод Hazelcast на 100%</p>
                </section>
                <section>
                    <h1>Распространение влияния</h1>
                    <ol>
                        <li class="fragment">Hazelcast начал медленно отвечать, а затем у него закончились файловые
                            дескрипторы</li>
                        <li class="fragment">Основной API начал медленно отвечать на запросы или отвечать с ошибкой</li>
                        <li class="fragment">Системы обращающиеся к API начали посторять запросы</li>
                        <ul class="fragment">
                            <li>Еще больше увеличили нагрузку на API</li>
                            <li>Увеличили нагрузку на соседние системы (которые надо вызывать совместно с API, или
                                которые вызывает API в процессе работы)</li>
                        </ul>
                    </ol>
                </section>
                <section>
                    <h1>Влияние на Банк</h1>
                    <ul>
                        <li class="fragment">Ошибки при входе в мобильные приложения</li>
                        <li class="fragment">Не загружались счета</li>
                        <li class="fragment">Не работали платежи и переводы</li>
                    </ul>
                </section>
                <section>
                    <h1>Влияние на Страховую</h1>
                    <ul>
                        <li class="fragment">Невозможно было рассчитать, оформить продлить и облатить ОСАГО</li>
                    </ul>
                </section>
                <section>
                    <h1>Влияние на Инвестиции</h1>
                    <ul>
                        <li class="fragment">Трудно войти в приложение</li>
                        <li class="fragment">Пользователи не видели свои счета</li>
                        <li class="fragment">Не получалось получить информацию о ценных бумагах</li>
                        <li class="fragment">Не возможно купить или продать бумаги, виставить лимитные заявки</li>
                    </ul>
                </section>
                <section>
                    <h1>Влияние на другие сервисы</h1>
                    <ul>
                        <li class="fragment">Не работал голосовой помощник</li>
                        <li class="fragment">Нельзя было записать телефонный разговор</li>
                        <li class="fragment">На колценнтр скопилась огромная очередь</li>
                        <li class="fragment">Внимание со стороны регулятора</li>
                        <li class="fragment">Просели рейтинги приложений в AppStore и Google Play</li>
                    </ul>
                </section>
                <section>
                    <h1>Выводы</h1>
                    <ul>
                        <li class="fragment">Вспомогательные приложения должны быть ограничены по максимальному
                            использованию ресурсов</li>
                        <li class="fragment">Надо очень внимательно продумывать работу приложений во время сбоев,
                            особенно при повторных вызовах</li>
                        <li class="fragment">Необходим план действий во время масштабных сбоев, включая работу
                            поддержки
                            и PR</li>
                    </ul>
                </section>
            </section>
            <section>
                <h1>Спасибо за внимание!</h1>
                <p>Вопросы?</p>
            </section>
        </div>
    </div>
</body>

</html>